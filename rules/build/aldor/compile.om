# Debugger to run the aldor compiler in.
DBG = $(EMPTY)

local_AFLAGS[] =
  -Fao
  -Fai
  -Fap
  -Fasy
  -Ffm
  -Fc
  -Flsp
  -Waudit
  -Wcheck
  -Wno-fatal
  #-Wdebug
  -I$(includedir)

common_AFLAGS[] =
  -Mno-ALDOR_W_NotCreatingFile
  -Mno-ALDOR_W_WillObsolete
  -B$(stagingdir)


###########################################################
# :: Compute each object's target-local dependencies.
###########################################################

dependencies-local (target) =
  .STATIC: :key: $(fullname $(target))
    DEPS		= $(EMPTY)
    LOCALDOMAINS	= $(basename $(InternalDomains) $(Domains))
    foreach (d, $(dependencies-all $(target))):
      if $(equal .ao, $(suffix $d)):
        if $(mem $(basename $(removesuffix $d)), $(LOCALDOMAINS)):
          DEPS = $(DEPS) $d
          export
        export
      export
    #eprintln ($"$(target) -> $(DEPS)")
    result = $(link-sort $(filter-out $(target), $(DEPS)))
  value $(result)


###########################################################
# :: Aldor compilation rules.
###########################################################

%.ai %.ap %.asy %.ao %.fm %.lsp %.c: %.as $(ALDOR)
  section rule:
    if $(EntryPoint):
      # This is a program.
      %.ai %.ap %.asy %.ao %.fm %.lsp %.c: %.as $(ALDOR)
        $(DBG) $(ALDOR)			\
          $(local_AFLAGS)		\
          $(common_AFLAGS)		\
          $(om_AFLAGS)			\
          $(ALDOROPT)			\
          $(USERFLAGS)			\
          -I$(curdir)/include		\
          $<

    else
      # Otherwise, it's a library.
      %.ai %.ap %.asy %.ao %.fm %.lsp %.c: %.as $(ALDOR)
        $(AR) cr lib$(Name)_$*.al $(dependencies-local $*.ao)
        $(DBG) $(ALDOR)			\
          $(local_AFLAGS)		\
          $(common_AFLAGS)		\
          $(om_AFLAGS)			\
          $(ALDOROPT)			\
          $(USERFLAGS)			\
          -I$(curdir)/include		\
          -L$(AldorName)Lib=$(Name)_$*	\
          -DBuild$(AldorName)Lib	\
          $<
        rm -f lib$(Name)_$*.al


# C main() function.
%main.c: %.ao $(ALDOR)
  $(ALDOR)				\
    -Fmain				\
    $(common_AFLAGS)			\
    $<
  mv aldormain.c $@
